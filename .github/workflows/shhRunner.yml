name: SSH VPN Automation
on:
  schedule:
    +-- cron: '0 */4 * * *' # اجرای خودکار هر ۴ ساعت [۵۸۳]
  workflow_dispatch:

jobs:
  ssh-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Server
        run: |
          # ۱. تنظیم رمز عبور برای یوزر runner [۱۷۴]
          echo "runner:${{ secrets.SSH_PASSWORD }}" | sudo chpasswd
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

          # ۲. نصب و اجرای تونل آرگو برای پورت ۲۲ [۵۸۲، ۶۸۴]
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          # اجرای تونل موقت (برای پایداری بیشتر می‌توانید از توکن ثابت استفاده کنید) [۶۸۵]
          nohup ./cloudflared tunnel --url ssh://localhost:22 > argo.log 2>&1 &
          
          # ۳. استخراج لینک آرگو و نمایش در لاگ [۶۸۵]
          sleep 10
          echo "Your SSH Address is:"
          grep -o 'https://[a-zA-Z0-9.-]*\.trycloudflare.com' argo.log | sed 's/https:\/\///'
          
          # ۴. زنده نگه داشتن رانر [۵۸۲]
          sleep infinity
